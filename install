#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
LIB_DIR=/usr/local/lib/llm-janitor
BIN_DIR=/usr/local/bin

[ -w "$(dirname "$LIB_DIR")" ] || { echo "Can't write to $(dirname "$LIB_DIR")"; exit 1; }
[ -w "$BIN_DIR" ] || { echo "Can't write to $BIN_DIR"; exit 1; }

mkdir -p "$LIB_DIR"

for src_file in "$SCRIPT_DIR"/*.sh "$SCRIPT_DIR"/llm-janitor; do
  base_name="${src_file##*/}"
  dest_file="$LIB_DIR/$base_name"

  if [[ ! -f "$dest_file" ]] || ! cmp -s "$src_file" "$dest_file"; then
    cp -a "$src_file" "$dest_file"
    echo "Copied $base_name"
  fi
done

bin_link="$BIN_DIR/llm-janitor"
lib_target="$LIB_DIR/llm-janitor"
if [[ ! -L "$bin_link" ]] || [[ "$(readlink "$bin_link")" != "$lib_target" ]]; then
  rm -f "$bin_link"
  ln -s "$lib_target" "$bin_link"
  echo "Linked $bin_link"
fi
